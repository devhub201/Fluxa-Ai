<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fluxa AI | Secure Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        :root { --blue-primary: #4285f4; }
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; overflow: hidden; }
        .dark body { background-color: #131314; color: #e3e3e3; }
        #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 40; }
        .auth-card { animation: slideUp 0.5s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        pre { border-radius: 0.5rem; margin: 1rem 0; background: #1e1e1e !important; }
        .message-user { background: #e9eef6; border-radius: 1.2rem 1.2rem 0 1.2rem; }
        .dark .message-user { background: #2b2b2b; }
        @media (max-width: 768px) { #sidebar { transform: translateX(-100%); } #sidebar.open { transform: translateX(0); } }
    </style>
</head>
<body class="transition-colors duration-200">

    <div id="auth-overlay" class="fixed inset-0 z-[100] bg-white dark:bg-[#131314] flex items-center justify-center p-4">
        <div class="auth-card w-full max-w-md p-8 bg-white dark:bg-[#1e1f20] rounded-3xl shadow-2xl border border-gray-100 dark:border-gray-800 text-center">
            <div class="mb-6">
                <div class="w-16 h-16 bg-blue-600 rounded-2xl mx-auto flex items-center justify-center mb-4 shadow-lg shadow-blue-500/30">
                    <span class="text-white text-3xl font-bold">F</span>
                </div>
                <h2 class="text-2xl font-bold">Welcome to Fluxa AI</h2>
                <p class="text-gray-500 mt-2">Sign in to start your session</p>
            </div>
            <div class="space-y-4">
                <input type="email" id="auth-email" placeholder="Enter your email" class="w-full p-4 rounded-xl border dark:bg-black dark:border-gray-700 outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                <button onclick="handleLogin()" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl transition-all active:scale-95">Continue</button>
                <p class="text-xs text-gray-400">By continuing, you agree to Fluxa's terms of service.</p>
            </div>
        </div>
    </div>

    <div id="app-shell" class="hidden flex h-screen w-full relative">
        
        <aside id="sidebar" class="fixed md:static inset-y-0 left-0 w-[280px] bg-[#f0f4f9] dark:bg-[#1e1f20] flex flex-col p-4 border-r border-gray-200 dark:border-gray-800">
            <div class="flex items-center justify-between mb-8">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-xs">F</div>
                    <span class="font-bold text-lg tracking-tight">Fluxa AI</span>
                </div>
                <button onclick="toggleSidebar()" class="md:hidden p-2">âœ•</button>
            </div>

            <button onclick="createNewChat()" class="flex items-center gap-3 w-full p-4 bg-gray-200 dark:bg-[#2b2b2b] hover:bg-gray-300 dark:hover:bg-gray-700 rounded-2xl transition-all mb-6">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                <span class="text-sm font-semibold">New Chat</span>
            </button>

            <div id="chat-history" class="flex-1 overflow-y-auto no-scrollbar space-y-1"></div>

            <div class="mt-auto pt-4 border-t border-gray-200 dark:border-gray-700 space-y-1">
                <div id="admin-entry"></div>
                <button onclick="toggleDarkMode()" class="w-full flex items-center gap-3 px-3 py-3 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-xl transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    <span class="text-sm">Appearance</span>
                </button>
                <button onclick="handleLogout()" class="w-full flex items-center gap-3 px-3 py-3 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/10 rounded-xl transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    <span class="text-sm">Sign Out</span>
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full bg-white dark:bg-[#131314]">
            <header class="h-16 flex items-center justify-between px-6 border-b border-gray-100 dark:border-gray-800">
                <button onclick="toggleSidebar()" class="md:hidden p-2 -ml-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
                <div class="flex items-center gap-4">
                    <span id="active-model" class="text-xs font-bold uppercase tracking-widest text-gray-400">GPT-4o</span>
                </div>
                <div id="user-badge" class="w-8 h-8 rounded-full bg-purple-500 flex items-center justify-center text-white text-xs font-bold uppercase"></div>
            </header>

            <div id="chat-window" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-8 no-scrollbar pb-32">
                <div id="empty-state" class="h-full flex flex-col items-center justify-center opacity-40">
                    <h1 class="text-5xl font-bold mb-4">Fluxa AI</h1>
                    <p class="text-lg">How can I help you today?</p>
                </div>
            </div>

            <div class="p-4 bg-white dark:bg-[#131314]">
                <div class="max-w-4xl mx-auto relative group">
                    <textarea id="main-input" rows="1" placeholder="Type a message..." class="w-full p-4 pr-16 rounded-2xl border border-gray-200 dark:border-gray-800 bg-[#f0f4f9] dark:bg-[#1e1f20] focus:ring-2 focus:ring-blue-500 focus:outline-none resize-none shadow-sm transition-all"></textarea>
                    <button onclick="sendMessage()" class="absolute right-3 bottom-3 p-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition-colors shadow-lg shadow-blue-500/20">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="3" d="M5 12h14M12 5l7 7-7 7"></path></svg>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <div id="admin-modal" class="fixed inset-0 z-[110] bg-black/60 backdrop-blur-sm hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-[#1e1f20] w-full max-w-lg rounded-3xl overflow-hidden shadow-2xl">
            <div class="p-6 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center">
                <h3 class="font-bold text-xl">Admin Settings</h3>
                <button onclick="closeAdmin()" class="text-2xl">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">OpenAI Key</label>
                    <input type="password" id="cfg-key" class="w-full p-3 bg-gray-50 dark:bg-black rounded-xl border dark:border-gray-700">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">Model Selection</label>
                    <select id="cfg-model" class="w-full p-3 bg-gray-50 dark:bg-black rounded-xl border dark:border-gray-700">
                        <option value="gpt-4o">GPT-4o (Omni)</option>
                        <option value="gpt-4-turbo">GPT-4 Turbo</option>
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">AI Personality (System Prompt)</label>
                    <textarea id="cfg-prompt" rows="3" class="w-full p-3 bg-gray-50 dark:bg-black rounded-xl border dark:border-gray-700"></textarea>
                </div>
            </div>
            <div class="p-6 bg-gray-50 dark:bg-[#1a1a1c] flex justify-end gap-3">
                <button onclick="closeAdmin()" class="px-6 py-2 rounded-xl font-medium">Cancel</button>
                <button onclick="saveAdmin()" class="px-6 py-2 bg-blue-600 text-white rounded-xl font-medium shadow-lg shadow-blue-500/20">Save Configuration</button>
            </div>
        </div>
    </div>

    <script>
        const ADMIN_EMAIL = "anujgupta20010@gmail.com";
        let state = {
            user: JSON.parse(localStorage.getItem('fluxa_auth') || 'null'),
            chats: JSON.parse(localStorage.getItem('fluxa_chats') || '[]'),
            activeId: null,
            config: JSON.parse(localStorage.getItem('fluxa_config') || JSON.stringify({
                key: '',
                model: 'gpt-4o',
                prompt: 'You are Fluxa AI, a high-performance frontend expert and UX architect.',
                theme: 'light'
            }))
        };

        // --- AUTH SYSTEM ---
        function checkAuth() {
            if (state.user) {
                document.getElementById('auth-overlay').classList.add('hidden');
                document.getElementById('app-shell').classList.remove('hidden');
                document.getElementById('user-badge').innerText = state.user.email[0];
                renderHistory();
                renderAdminBtn();
                initTheme();
            }
        }

        function handleLogin() {
            const email = document.getElementById('auth-email').value.toLowerCase().trim();
            if (!email.includes('@')) return alert("Enter a valid email");
            
            state.user = { email, loginAt: Date.now() };
            localStorage.setItem('fluxa_auth', JSON.stringify(state.user));
            checkAuth();
        }

        function handleLogout() {
            localStorage.removeItem('fluxa_auth');
            location.reload();
        }

        // --- UI CORE ---
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
        function initTheme() {
            if (state.config.theme === 'dark') document.documentElement.classList.add('dark');
            else document.documentElement.classList.remove('dark');
        }
        function toggleDarkMode() {
            state.config.theme = state.config.theme === 'light' ? 'dark' : 'light';
            localStorage.setItem('fluxa_config', JSON.stringify(state.config));
            initTheme();
        }

        function renderAdminBtn() {
            if (state.user.email === ADMIN_EMAIL) {
                document.getElementById('admin-entry').innerHTML = `
                    <button onclick="openAdmin()" class="w-full flex items-center gap-3 px-3 py-3 text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/10 rounded-xl transition-colors font-semibold">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path></svg>
                        <span class="text-sm">Admin Panel</span>
                    </button>
                `;
            }
        }

        // --- CHAT LOGIC ---
        function createNewChat() {
            const id = 'chat_' + Date.now();
            state.chats.unshift({ id, title: 'New Conversation', messages: [] });
            state.activeId = id;
            updateStore();
            renderHistory();
            renderMessages();
            if (window.innerWidth < 768) toggleSidebar();
        }

        async function sendMessage() {
            const input = document.getElementById('main-input');
            const text = input.value.trim();
            if (!text || !state.config.key) return !state.config.key && openAdmin();

            if (!state.activeId) createNewChat();
            const chat = state.chats.find(c => c.id === state.activeId);
            
            // Add User Message
            chat.messages.push({ role: 'user', content: text });
            if (chat.messages.length === 1) chat.title = text.slice(0, 30);
            
            input.value = '';
            renderMessages();

            // Add AI Placeholder
            const aiId = 'ai_' + Date.now();
            chat.messages.push({ role: 'assistant', content: '', id: aiId });
            renderMessages();

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${state.config.key}` },
                    body: JSON.stringify({
                        model: state.config.model,
                        messages: [{ role: 'system', content: state.config.prompt }, ...chat.messages.filter(m => !m.id).slice(-6)],
                        stream: true
                    })
                });

                const reader = response.body.getReader();
                let fullText = "";
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = new TextDecoder().decode(value);
                    const lines = chunk.split('\n');
                    for (const line of lines) {
                        if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                            const data = JSON.parse(line.substring(6));
                            fullText += data.choices[0].delta.content || "";
                            document.getElementById(aiId).innerHTML = marked.parse(fullText);
                        }
                    }
                }
                chat.messages[chat.messages.length - 1].content = fullText;
                updateStore();
                Prism.highlightAll();
            } catch (e) { alert("API Error. Verify key in Admin."); }
        }

        function renderMessages() {
            const win = document.getElementById('chat-window');
            if (!state.activeId) { win.innerHTML = document.getElementById('empty-state').outerHTML; return; }
            const chat = state.chats.find(c => c.id === state.activeId);
            
            win.innerHTML = chat.messages.map(m => `
                <div class="flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}">
                    <div class="max-w-[85%] md:max-w-[75%] ${m.role === 'user' ? 'message-user p-4 shadow-sm' : 'p-2'}">
                        <div class="prose prose-sm dark:prose-invert max-w-none" id="${m.id || ''}">${marked.parse(m.content || '...')}</div>
                    </div>
                </div>
            `).join('');
            win.scrollTop = win.scrollHeight;
            Prism.highlightAll();
        }

        function renderHistory() {
            const hist = document.getElementById('chat-history');
            hist.innerHTML = state.chats.map(c => `
                <div onclick="selectChat('${c.id}')" class="group flex items-center justify-between p-3 rounded-xl cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-800 transition-all ${state.activeId === c.id ? 'bg-gray-200 dark:bg-gray-800' : ''}">
                    <span class="truncate text-sm font-medium pr-2">${c.title}</span>
                    <button onclick="event.stopPropagation(); deleteChat('${c.id}')" class="opacity-0 group-hover:opacity-100 p-1 hover:text-red-500 transition-opacity">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            `).join('');
        }

        function selectChat(id) { state.activeId = id; renderMessages(); renderHistory(); if(window.innerWidth < 768) toggleSidebar(); }
        function deleteChat(id) { state.chats = state.chats.filter(c => c.id !== id); if(state.activeId === id) state.activeId = null; updateStore(); renderHistory(); renderMessages(); }
        function updateStore() { localStorage.setItem('fluxa_chats', JSON.stringify(state.chats)); }

        // --- ADMIN MODAL ---
        function openAdmin() {
            document.getElementById('cfg-key').value = state.config.key;
            document.getElementById('cfg-model').value = state.config.model;
            document.getElementById('cfg-prompt').value = state.config.prompt;
            document.getElementById('admin-modal').style.display = 'flex';
        }
        function closeAdmin() { document.getElementById('admin-modal').style.display = 'none'; }
        function saveAdmin() {
            state.config.key = document.getElementById('cfg-key').value;
            state.config.model = document.getElementById('cfg-model').value;
            state.config.prompt = document.getElementById('cfg-prompt').value;
            localStorage.setItem('fluxa_config', JSON.stringify(state.config));
            document.getElementById('active-model').innerText = state.config.model;
            closeAdmin();
        }

        // Init
        window.onload = () => {
            checkAuth();
            const tx = document.getElementById('main-input');
            tx.addEventListener('input', () => { tx.style.height = 'auto'; tx.style.height = tx.scrollHeight + 'px'; });
            tx.addEventListener('keydown', (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }});
        };
    </script>
</body>
</html>

