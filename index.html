<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Fluxa AI</title>

<!-- Tailwind CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Marked.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
html, body {
  height: 100%;
}
.chat-scroll::-webkit-scrollbar {
  width: 6px;
}
.chat-scroll::-webkit-scrollbar-thumb {
  background: #d1d5db;
  border-radius: 10px;
}
.dark .chat-scroll::-webkit-scrollbar-thumb {
  background: #374151;
}
</style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex flex-col">

<!-- Loader -->
<div id="loading" class="fixed inset-0 flex items-center justify-center bg-white dark:bg-gray-900 z-50">
  <div class="text-xl font-semibold animate-pulse">Loading Fluxa AI...</div>
</div>

<div class="flex flex-1 overflow-hidden">

  <!-- Sidebar -->
  <aside id="sidebar" class="w-72 bg-white dark:bg-gray-800 border-r dark:border-gray-700 flex flex-col transition-transform duration-300 md:translate-x-0 -translate-x-full fixed md:static z-40 h-full">
    <div class="p-4 flex justify-between items-center border-b dark:border-gray-700">
      <h1 class="font-bold text-lg">Fluxa AI</h1>
      <button id="closeSidebar" class="md:hidden text-xl">✕</button>
    </div>

    <div class="p-2">
      <button id="newChatBtn" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">
        + New Chat
      </button>
    </div>

    <div id="chatList" class="flex-1 overflow-y-auto chat-scroll p-2 space-y-2"></div>

    <div class="p-3 border-t dark:border-gray-700 text-sm space-y-2">
      <button id="darkToggle" class="w-full py-1 rounded bg-gray-200 dark:bg-gray-700">
        Toggle Dark Mode
      </button>
      <button id="openSettings" class="w-full py-1 rounded bg-gray-200 dark:bg-gray-700">
        Settings
      </button>
      <button id="openAdmin" class="hidden w-full py-1 rounded bg-red-500 text-white">
        Admin Panel
      </button>
    </div>
  </aside>

  <!-- Main -->
  <div class="flex-1 flex flex-col relative min-h-screen">

    <!-- Mobile Header -->
    <div class="md:hidden p-3 border-b dark:border-gray-700 flex justify-between items-center">
      <button id="openSidebar" class="text-2xl">☰</button>
      <span class="font-semibold">Fluxa AI</span>
    </div>

    <!-- Chat Messages -->
    <div id="chatContainer" class="flex-1 overflow-y-auto chat-scroll p-4 space-y-4 pb-32"></div>

    <!-- Input Bar -->
    <div class="fixed bottom-0 left-0 md:left-72 right-0 bg-white dark:bg-gray-800 border-t dark:border-gray-700 p-3">
      <div class="max-w-4xl mx-auto flex gap-2">
        <textarea id="messageInput" rows="1"
          class="flex-1 resize-none rounded-lg border dark:border-gray-600 p-2 bg-gray-100 dark:bg-gray-700 focus:outline-none"
          placeholder="Type your message..."></textarea>
        <button id="sendBtn"
          class="bg-blue-600 text-white px-4 rounded-lg hover:bg-blue-700 transition">
          Send
        </button>
      </div>
    </div>

  </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
  <div class="bg-white dark:bg-gray-800 p-6 rounded-xl w-96 space-y-4">
    <h2 class="font-bold text-lg">Settings</h2>
    <input id="apiKeyInput" type="password" placeholder="OpenAI API Key"
      class="w-full p-2 rounded border dark:border-gray-600 bg-gray-100 dark:bg-gray-700">
    <input id="modelInput" type="text" placeholder="Model (gpt-4o-mini)"
      class="w-full p-2 rounded border dark:border-gray-600 bg-gray-100 dark:bg-gray-700">
    <textarea id="systemPromptInput" placeholder="System Prompt"
      class="w-full p-2 rounded border dark:border-gray-600 bg-gray-100 dark:bg-gray-700"></textarea>
    <div class="flex justify-end gap-2">
      <button id="closeSettings" class="px-4 py-1 bg-gray-300 dark:bg-gray-600 rounded">Close</button>
      <button id="saveSettings" class="px-4 py-1 bg-blue-600 text-white rounded">Save</button>
    </div>
  </div>
</div>

<!-- Admin Modal -->
<div id="adminModal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
  <div class="bg-white dark:bg-gray-800 p-6 rounded-xl w-[420px] space-y-4">
    <h2 class="font-bold text-lg text-red-500">Admin Panel</h2>
    <input id="adminEmailInput" type="email" placeholder="Admin Email"
      class="w-full p-2 rounded border dark:border-gray-600 bg-gray-100 dark:bg-gray-700">
    <button id="saveAdminEmail" class="bg-red-500 text-white px-4 py-2 rounded w-full">
      Save Admin Email
    </button>
    <button id="closeAdmin" class="w-full bg-gray-400 py-2 rounded">
      Close
    </button>
  </div>
</div>

<!-- SCRIPT AT END -->
<script>
(function(){

const ADMIN_EMAIL = "anujgupta20010@gmail.com";

const chatContainer = document.getElementById("chatContainer");
const chatList = document.getElementById("chatList");
const sidebar = document.getElementById("sidebar");

let chats = JSON.parse(localStorage.getItem("fluxa_chats") || "{}");
let currentChatId = localStorage.getItem("fluxa_current") || null;

function saveChats(){
  localStorage.setItem("fluxa_chats", JSON.stringify(chats));
}

function createChat(){
  const id = Date.now().toString();
  chats[id] = { title: "New Chat", messages: [] };
  currentChatId = id;
  saveChats();
  localStorage.setItem("fluxa_current", id);
  renderChats();
  renderMessages();
}

function renderChats(){
  chatList.innerHTML = "";
  Object.keys(chats).forEach(id=>{
    const div = document.createElement("div");
    div.className = "p-2 rounded cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700";
    div.textContent = chats[id].title;
    div.onclick = ()=>{ currentChatId=id; renderMessages(); };
    chatList.appendChild(div);
  });
}

function renderMessages(){
  chatContainer.innerHTML = "";
  if(!currentChatId || !chats[currentChatId]) return;
  chats[currentChatId].messages.forEach(m=>{
    const div = document.createElement("div");
    div.className = m.role==="user" 
      ? "text-right"
      : "text-left";
    const bubble = document.createElement("div");
    bubble.className = m.role==="user"
      ? "inline-block bg-blue-600 text-white px-4 py-2 rounded-xl"
      : "inline-block bg-gray-200 dark:bg-gray-700 px-4 py-2 rounded-xl";
    bubble.innerHTML = marked.parse(m.content);
    div.appendChild(bubble);
    chatContainer.appendChild(div);
  });
  chatContainer.scrollTop = chatContainer.scrollHeight;
}

async function sendMessage(){
  const input = document.getElementById("messageInput");
  const text = input.value.trim();
  if(!text || !currentChatId) return;
  input.value="";

  chats[currentChatId].messages.push({role:"user", content:text});
  renderMessages();
  saveChats();

  const aiMessage = {role:"assistant", content:""};
  chats[currentChatId].messages.push(aiMessage);
  renderMessages();

  const apiKey = localStorage.getItem("fluxa_apiKey");
  const model = localStorage.getItem("fluxa_model") || "gpt-4o-mini";
  const systemPrompt = localStorage.getItem("fluxa_system") || "You are a helpful AI.";

  try{
    const response = await fetch("https://api.openai.com/v1/chat/completions",{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":"Bearer "+apiKey
      },
      body:JSON.stringify({
        model:model,
        stream:true,
        messages:[
          {role:"system", content:systemPrompt},
          ...chats[currentChatId].messages
        ]
      })
    });

    const reader = response.body.getReader();
    const decoder = new TextDecoder("utf-8");

    while(true){
      const {value, done} = await reader.read();
      if(done) break;
      const chunk = decoder.decode(value);
      chunk.split("\n").forEach(line=>{
        if(line.startsWith("data: ")){
          const data = line.replace("data: ","");
          if(data==="[DONE]") return;
          try{
            const json = JSON.parse(data);
            const token = json.choices[0].delta.content;
            if(token){
              aiMessage.content += token;
              renderMessages();
            }
          }catch(e){}
        }
      });
    }

  }catch(err){
    aiMessage.content = "⚠ Error: "+err.message;
    renderMessages();
  }

  saveChats();
}

document.getElementById("sendBtn").onclick = sendMessage;
document.getElementById("newChatBtn").onclick = createChat;
document.getElementById("openSidebar").onclick = ()=> sidebar.classList.remove("-translate-x-full");
document.getElementById("closeSidebar").onclick = ()=> sidebar.classList.add("-translate-x-full");

document.getElementById("darkToggle").onclick = ()=>{
  document.documentElement.classList.toggle("dark");
  localStorage.setItem("fluxa_dark", document.documentElement.classList.contains("dark"));
};

if(localStorage.getItem("fluxa_dark")==="true"){
  document.documentElement.classList.add("dark");
}

document.getElementById("openSettings").onclick = ()=>{
  document.getElementById("settingsModal").classList.remove("hidden");
};
document.getElementById("closeSettings").onclick = ()=>{
  document.getElementById("settingsModal").classList.add("hidden");
};

document.getElementById("saveSettings").onclick = ()=>{
  localStorage.setItem("fluxa_apiKey", document.getElementById("apiKeyInput").value);
  localStorage.setItem("fluxa_model", document.getElementById("modelInput").value);
  localStorage.setItem("fluxa_system", document.getElementById("systemPromptInput").value);
  document.getElementById("settingsModal").classList.add("hidden");
};

if(ADMIN_EMAIL === "anujgupta20010@gmail.com"){
  document.getElementById("openAdmin").classList.remove("hidden");
}

document.getElementById("openAdmin").onclick = ()=>{
  document.getElementById("adminModal").classList.remove("hidden");
};
document.getElementById("closeAdmin").onclick = ()=>{
  document.getElementById("adminModal").classList.add("hidden");
};

document.getElementById("loading").style.display="none";

if(!currentChatId) createChat();
renderChats();
renderMessages();

})();
</script>

</body>
</html>            <div class="p-6 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center">
                <h3 class="font-bold text-xl">Admin Settings</h3>
                <button onclick="closeAdmin()" class="text-2xl">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">OpenAI Key</label>
                    <input type="password" id="cfg-key" class="w-full p-3 bg-gray-50 dark:bg-black rounded-xl border dark:border-gray-700">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">Model Selection</label>
                    <select id="cfg-model" class="w-full p-3 bg-gray-50 dark:bg-black rounded-xl border dark:border-gray-700">
                        <option value="gpt-4o">GPT-4o (Omni)</option>
                        <option value="gpt-4-turbo">GPT-4 Turbo</option>
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">AI Personality (System Prompt)</label>
                    <textarea id="cfg-prompt" rows="3" class="w-full p-3 bg-gray-50 dark:bg-black rounded-xl border dark:border-gray-700"></textarea>
                </div>
            </div>
            <div class="p-6 bg-gray-50 dark:bg-[#1a1a1c] flex justify-end gap-3">
                <button onclick="closeAdmin()" class="px-6 py-2 rounded-xl font-medium">Cancel</button>
                <button onclick="saveAdmin()" class="px-6 py-2 bg-blue-600 text-white rounded-xl font-medium shadow-lg shadow-blue-500/20">Save Configuration</button>
            </div>
        </div>
    </div>

    <script>
        const ADMIN_EMAIL = "anujgupta20010@gmail.com";
        let state = {
            user: JSON.parse(localStorage.getItem('fluxa_auth') || 'null'),
            chats: JSON.parse(localStorage.getItem('fluxa_chats') || '[]'),
            activeId: null,
            config: JSON.parse(localStorage.getItem('fluxa_config') || JSON.stringify({
                key: '',
                model: 'gpt-4o',
                prompt: 'You are Fluxa AI, a high-performance frontend expert and UX architect.',
                theme: 'light'
            }))
        };

        // --- AUTH SYSTEM ---
        function checkAuth() {
            if (state.user) {
                document.getElementById('auth-overlay').classList.add('hidden');
                document.getElementById('app-shell').classList.remove('hidden');
                document.getElementById('user-badge').innerText = state.user.email[0];
                renderHistory();
                renderAdminBtn();
                initTheme();
            }
        }

        function handleLogin() {
            const email = document.getElementById('auth-email').value.toLowerCase().trim();
            if (!email.includes('@')) return alert("Enter a valid email");
            
            state.user = { email, loginAt: Date.now() };
            localStorage.setItem('fluxa_auth', JSON.stringify(state.user));
            checkAuth();
        }

        function handleLogout() {
            localStorage.removeItem('fluxa_auth');
            location.reload();
        }

        // --- UI CORE ---
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
        function initTheme() {
            if (state.config.theme === 'dark') document.documentElement.classList.add('dark');
            else document.documentElement.classList.remove('dark');
        }
        function toggleDarkMode() {
            state.config.theme = state.config.theme === 'light' ? 'dark' : 'light';
            localStorage.setItem('fluxa_config', JSON.stringify(state.config));
            initTheme();
        }

        function renderAdminBtn() {
            if (state.user.email === ADMIN_EMAIL) {
                document.getElementById('admin-entry').innerHTML = `
                    <button onclick="openAdmin()" class="w-full flex items-center gap-3 px-3 py-3 text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/10 rounded-xl transition-colors font-semibold">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path></svg>
                        <span class="text-sm">Admin Panel</span>
                    </button>
                `;
            }
        }

        // --- CHAT LOGIC ---
        function createNewChat() {
            const id = 'chat_' + Date.now();
            state.chats.unshift({ id, title: 'New Conversation', messages: [] });
            state.activeId = id;
            updateStore();
            renderHistory();
            renderMessages();
            if (window.innerWidth < 768) toggleSidebar();
        }

        async function sendMessage() {
            const input = document.getElementById('main-input');
            const text = input.value.trim();
            if (!text || !state.config.key) return !state.config.key && openAdmin();

            if (!state.activeId) createNewChat();
            const chat = state.chats.find(c => c.id === state.activeId);
            
            // Add User Message
            chat.messages.push({ role: 'user', content: text });
            if (chat.messages.length === 1) chat.title = text.slice(0, 30);
            
            input.value = '';
            renderMessages();

            // Add AI Placeholder
            const aiId = 'ai_' + Date.now();
            chat.messages.push({ role: 'assistant', content: '', id: aiId });
            renderMessages();

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${state.config.key}` },
                    body: JSON.stringify({
                        model: state.config.model,
                        messages: [{ role: 'system', content: state.config.prompt }, ...chat.messages.filter(m => !m.id).slice(-6)],
                        stream: true
                    })
                });

                const reader = response.body.getReader();
                let fullText = "";
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = new TextDecoder().decode(value);
                    const lines = chunk.split('\n');
                    for (const line of lines) {
                        if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                            const data = JSON.parse(line.substring(6));
                            fullText += data.choices[0].delta.content || "";
                            document.getElementById(aiId).innerHTML = marked.parse(fullText);
                        }
                    }
                }
                chat.messages[chat.messages.length - 1].content = fullText;
                updateStore();
                Prism.highlightAll();
            } catch (e) { alert("API Error. Verify key in Admin."); }
        }

        function renderMessages() {
            const win = document.getElementById('chat-window');
            if (!state.activeId) { win.innerHTML = document.getElementById('empty-state').outerHTML; return; }
            const chat = state.chats.find(c => c.id === state.activeId);
            
            win.innerHTML = chat.messages.map(m => `
                <div class="flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}">
                    <div class="max-w-[85%] md:max-w-[75%] ${m.role === 'user' ? 'message-user p-4 shadow-sm' : 'p-2'}">
                        <div class="prose prose-sm dark:prose-invert max-w-none" id="${m.id || ''}">${marked.parse(m.content || '...')}</div>
                    </div>
                </div>
            `).join('');
            win.scrollTop = win.scrollHeight;
            Prism.highlightAll();
        }

        function renderHistory() {
            const hist = document.getElementById('chat-history');
            hist.innerHTML = state.chats.map(c => `
                <div onclick="selectChat('${c.id}')" class="group flex items-center justify-between p-3 rounded-xl cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-800 transition-all ${state.activeId === c.id ? 'bg-gray-200 dark:bg-gray-800' : ''}">
                    <span class="truncate text-sm font-medium pr-2">${c.title}</span>
                    <button onclick="event.stopPropagation(); deleteChat('${c.id}')" class="opacity-0 group-hover:opacity-100 p-1 hover:text-red-500 transition-opacity">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            `).join('');
        }

        function selectChat(id) { state.activeId = id; renderMessages(); renderHistory(); if(window.innerWidth < 768) toggleSidebar(); }
        function deleteChat(id) { state.chats = state.chats.filter(c => c.id !== id); if(state.activeId === id) state.activeId = null; updateStore(); renderHistory(); renderMessages(); }
        function updateStore() { localStorage.setItem('fluxa_chats', JSON.stringify(state.chats)); }

        // --- ADMIN MODAL ---
        function openAdmin() {
            document.getElementById('cfg-key').value = state.config.key;
            document.getElementById('cfg-model').value = state.config.model;
            document.getElementById('cfg-prompt').value = state.config.prompt;
            document.getElementById('admin-modal').style.display = 'flex';
        }
        function closeAdmin() { document.getElementById('admin-modal').style.display = 'none'; }
        function saveAdmin() {
            state.config.key = document.getElementById('cfg-key').value;
            state.config.model = document.getElementById('cfg-model').value;
            state.config.prompt = document.getElementById('cfg-prompt').value;
            localStorage.setItem('fluxa_config', JSON.stringify(state.config));
            document.getElementById('active-model').innerText = state.config.model;
            closeAdmin();
        }

        // Init
        window.onload = () => {
            checkAuth();
            const tx = document.getElementById('main-input');
            tx.addEventListener('input', () => { tx.style.height = 'auto'; tx.style.height = tx.scrollHeight + 'px'; });
            tx.addEventListener('keydown', (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }});
        };
    </script>
</body>
</html>

